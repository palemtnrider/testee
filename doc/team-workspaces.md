# Team Workspaces

## Explanation

The process of setting up a new WKP cluster creates two objects: an EKS cluster and a GitOps repository (that we call a cluster repository). The cluster repository contains the configuration for the cluster itself as well as cluster components providing its services. The cluster repository is not designed to keep track of workloads. When you want to run a new application in your cluster, you should do that in a workspace.

### What is a workspace?

A workspace is a GitOps repository tied to a namespace in a WKP cluster, and a Flux instance keeping them in sync. All Kubernetes objects created in the workspace repository are applied in the specified namespace by the workspace Flux. One can create a workspace by adding an entry in [`cluster/platform/team-workspaces.yaml`](../cluster/platform/team-workspaces.yaml) in the cluster repository. The WKP UI simplifies that to just a few clicks.

### How are workspaces automated?

1. Cluster Operator makes a commit to the cluster repository. This commit adds an entry to [`cluster/platform/team-workspaces.yaml`](../cluster/platform/team-workspaces.yaml)
   - This step can be done directly from the WKP UI - see [How To: Create and use a team workspace](#how-to-create-and-use-a-team-workspace). In such case, a backend service called _`wkp-gitops-repo-broker`_ makes the appropriate Git commit(s) on behalf of the UI user.
2. Flux running in the cluster repository applies the following objects to the cluster:
   - a dedicated `Namespace`,
   - a `GitRepository` - a Kubernetes _custom resource (CR)_ that (declaratively) defines a remote repository and its read/write permissions,
   - a Flux instance configured to match the workspace Git repository and the repository namespace.


### How do workspaces control repository permissions?

The `GitRepository` format allows the cluster operator to specify, for every git repository, a list of teams and their corresponding access levels (`pull`, `push`, `admin`).

### Current limitations

- Only GitHub is supported for remote repositories.
- Repository lifecycle: only creation is supported. No Git repositories are deleted without manual action.
- Permission lifecycle: only creation and addition of `team`-`repo`-`accessLevel` triplets is supported. No support for removing access rights other than by manual action.

## How To: Create and use a team workspace

1. Navigate to the **WKP UI** and scroll down to _Workspaces_.
2. Click **Create Workspace** and fill in the form:
   1. Choose the organization from the drop-down list. This is a list of existing git provider organizations.
   2. Pick an existing GitHub team in the chosen organization from the drop-down list. 
   3. Come up with a repository name unique to the git provider organization and enter it in the **Git repo name** field. The name is pre-populated with a sensible default.
   4. Observe the **Namespace** name for the workspace. It is autogenerated.
   5. Click **Create workspace**
3. Wait until the workspace name link becomes active and pointing to an existing GitHub repo. This shouldn't take longer than the Flux sync interval plus a few seconds.
   - _Note: for troubleshooting, check Flux logs (for applying failures) 
4. Commit something to the newly created workspace repository (accessible by the workspace link in the UI). A workspace-specific Flux will reconcile your changes with the workspace namespace.
